# Firebase Firestore & Storage Security Rules

## Issue
When downloading encrypted files, you get a 403 "Permission denied" error from Firebase Storage.

## Root Cause
The download URLs generated by `getDownloadURL()` are public by default, BUT if you have restrictive security rules or they're not configured, the fetch may fail.

## Solution

### Firebase Storage Rules (`storage.rules`)

Create or update your `storage.rules` file to allow:
1. Anyone to download files (they're encrypted anyway)
2. Only authenticated users to upload

```
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Allow anyone to read files (they're encrypted client-side)
    match /uploads/{allPaths=**} {
      allow read;
      allow write: if request.auth != null;
    }
    
    // Profile avatars: only owner can write, anyone can read
    match /avatars/{userId}/{allPaths=**} {
      allow read;
      allow write: if request.auth.uid == userId;
    }
  }
}
```

### Firestore Rules (`firestore.rules`)

Ensure `sharedFiles` collection is readable:

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own profile
    match /users/{uid} {
      allow read, write: if request.auth.uid == uid;
    }
    
    // Anyone can read sharedFiles (metadata is not sensitive, file content is encrypted)
    match /sharedFiles/{document=**} {
      allow read;
      allow write: if request.auth != null;
    }
  }
}
```

## How to Deploy Rules

### Via Firebase Console (Easiest)
1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. **Firestore Database** → **Rules** tab → paste the rules above → Publish
4. **Storage** → **Rules** tab → paste the rules above → Publish

### Via Firebase CLI
```bash
firebase deploy --only firestore:rules,storage
```

## After Applying Rules

1. Refresh your browser
2. Sign in
3. Upload a file
4. Share it with recipient's email
5. Recipient signs in and should be able to download/decrypt

## Testing

- Open Browser DevTools (F12)
- Click "Decrypt & Download"
- Check **Console** tab for logs showing:
  - `Fetching encrypted file from: https://...`
  - `Decrypting file...`
  - `File downloaded successfully`
- Or see the fetch error message if it fails

## Troubleshooting

**Still getting 403?**
- Check that you're signed in (onAuthStateChanged shows a user)
- Check the file URL is a valid Google Storage download link (`storage.googleapis.com`)
- Verify the file was actually uploaded to Firebase Storage (check console during upload)
- Check that the Firestore `sharedFiles` document has a `fileUrl` field

**File exists but fetch fails?**
- The Storage rules might still be too restrictive
- Temporarily set rules to:
  ```
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      allow read, write;
    }
  }
  ```
  (This is for testing only — do not use in production without auth)

